import{dp as e,p as t,h as l,x as a,_ as n,m as o,h9 as s,dr as i}from"./page_layout.js?v=1767769852656";import{i as c}from"./public.js?v=1767769852656";import{aX as r,aC as u,dV as d,dR as p,dd as f,au as v,de as h,dW as m}from"./naive.js?v=1767769852656";import{k as _,ae as g,r as w,a2 as x,V as y,a3 as b,W as C,j as F,a4 as k,s as U,U as W,P as $,c as j,R as E,F as O,l as I,S as M,v as R,ad as B,an as P,ay as z,O as A,aL as L,t as N,e as S,ak as V,n as q}from"./vue.js?v=1767769852656";import"./common.js?v=1767769852656";import"./__commonjsHelpers__.js?v=1767769852656";const H=_({__name:"site-select",props:{value:{},valueModifiers:{}},emits:["update:value"],setup(t){const l=g(t,"value"),a=e(),n=w([]),o=()=>{l.value=n.value.map(e=>e.value)},s=()=>{l.value=[]};return(async()=>{n.value=Object.entries(a.config.sitemap).map(([e,t])=>({label:e,value:t}))})(),(e,t)=>{const a=u,i=r,c=d;return y(),x(c,U(e.$attrs,{value:l.value,"onUpdate:value":t[0]||(t[0]=e=>l.value=e),multiple:"",filterable:"",options:W(n),"max-tag-count":"responsive","consistent-menu-width":!1,placeholder:e.$t("Waf.Custom.index_25")}),{header:b(()=>[C(i,{class:"w-full"},{default:b(()=>[C(a,{class:"flex-1",onClick:o},{default:b(()=>[F(k(e.$t("Public.All")),1)]),_:1}),C(a,{class:"flex-1",onClick:s},{default:b(()=>[F(k(e.$t("Public.Btn.Cancel")),1)]),_:1})]),_:1})]),_:1},16,["value","options","placeholder"])}}}),X={class:"w-320px"},D={class:"w-320px"},G=_({__name:"action",props:{action:{default:""},actionModifiers:{},response:{},responseModifiers:{}},emits:["update:action","update:response"],setup(t){const{t:l}=$(),a=e(),n=g(t,"action"),o=g(t,"response"),s=w([]),i=j(()=>{let e="";switch(n.value){case"deny":e=l("Waf.Custom.index_21");break;case"validate":e=l("Waf.Custom.index_32")}return e}),c=j(()=>r(n.value).map(e=>({label:e.text,value:e.type,data:e}))),r=e=>{const t=a.config.action.filter(t=>t.type===e);return t.length>0?t[0].response:[]},u=e=>{const t=r(e);t.length>0?o.value=t[0].type:o.value=null};return s.value=a.config.action.map(e=>({label:e.text,value:e.type,data:e})),null===o.value&&u(n.value),(e,t)=>{const l=d,a=p;return y(),E(O,null,[C(a,{label:e.$t("Waf.Custom.index_20")},{default:b(()=>[M("div",X,[C(l,{value:n.value,"onUpdate:value":[t[0]||(t[0]=e=>n.value=e),u],options:W(s)},null,8,["value","options"])])]),_:1},8,["label"]),I(C(a,{label:W(i),"show-feedback":!1},{default:b(()=>[M("div",D,[C(l,{value:o.value,"onUpdate:value":t[1]||(t[1]=e=>o.value=e),options:W(c)},null,8,["value","options"])])]),_:1},8,["label"]),[[R,W(c).length>0]])],64)}}}),J={class:"my-18px"};const K=t({},[["render",function(e,t){const l=f;return y(),E("div",J,[C(l,{class:"w-38px justify-center"},{default:b(()=>[F(k(e.$t("Waf.Custom.index_31")),1)]),_:1})])}]]),Q={class:"flex flex-center flex-col w-38px"};const T=t({},[["render",function(e,t){const l=f;return y(),E("div",Q,[t[0]||(t[0]=M("div",{class:"seg"},null,-1)),C(l,{class:"w-38px justify-center"},{default:b(()=>[F(k(e.$t("Waf.Custom.index_30")),1)]),_:1}),t[1]||(t[1]=M("div",{class:"seg"},null,-1))])}],["__scopeId","data-v-7ea28fa1"]]),Y={class:"relative flex items-center w-full h-full"},Z={class:"tips"},ee=t(_({__name:"content",props:B({condition:{default:null},factor:{},type:{default:"right"}},{input:{},inputModifiers:{},select:{default:()=>null},selectModifiers:{}}),emits:["update:input","update:select"],setup(e){const t=e,n=g(e,"input"),o=g(e,"select"),s=j(()=>null===t.condition),i=["in","not_in"],c=j(()=>{const{factor:e}=t;return"text"===e.widget.type}),p=["select","area_select","mult"],f=j(()=>{const{factor:e}=t;return p.includes(e.widget.type)}),h=j(()=>"left"!==t.type&&("mult"===t.factor.widget.type||i.includes(t.condition||""))),m=j(()=>{const{factor:e}=t,{widget:a}=e;return a.value.map(e=>({label:l(e)?e:e.label,value:l(e)?e:e.key}))}),_=()=>{o.value=m.value.map(e=>e.value)},U=()=>{o.value=[]},$=w(""),I=e=>{$.value=e},R=()=>{""!==$.value&&(a(o.value)?a(o.value)&&!o.value.includes($.value)&&o.value.push($.value):o.value=[$.value],$.value="")};return(e,t)=>{const l=v,a=d,i=u,p=r;return y(),E("div",Y,[W(c)?(y(),E(O,{key:0},[W(h)?(y(),x(a,{key:1,value:o.value,"onUpdate:value":t[1]||(t[1]=e=>o.value=e),tag:"",multiple:"",filterable:"","show-arrow":!1,show:!1,"max-tag-count":"responsive","consistent-menu-width":!1,placeholder:e.factor.widget.placeholder,onSearch:I,onBlur:R},null,8,["value","placeholder"])):(y(),x(l,{key:0,value:n.value,"onUpdate:value":t[0]||(t[0]=e=>n.value=e),spellcheck:"false",disabled:W(s),placeholder:e.factor.widget.placeholder},null,8,["value","disabled","placeholder"])),M("div",Z,k(e.factor.widget.hint?"".concat(e.factor.widget.hint).concat(W(h)?e.$t("Waf.Custom.index_29"):""):""),1)],64)):P("",!0),W(f)?(y(),x(a,{key:1,value:o.value,"onUpdate:value":t[2]||(t[2]=e=>o.value=e),options:W(m),disabled:W(s),filterable:!0,"consistent-menu-width":!1,multiple:W(h),"max-tag-count":"responsive",placeholder:e.factor.widget.placeholder},z({_:2},[W(h)?{name:"header",fn:b(()=>[C(p,{class:"w-full"},{default:b(()=>[C(i,{class:"flex-1",onClick:_},{default:b(()=>[F(k(e.$t("Public.All")),1)]),_:1}),C(i,{class:"flex-1",onClick:U},{default:b(()=>[F(k(e.$t("Public.Btn.Cancel")),1)]),_:1})]),_:1})]),key:"0"}:void 0]),1032,["value","options","disabled","multiple","placeholder"])):P("",!0)])}}}),[["__scopeId","data-v-c8f1f83a"]]),te={class:"rows rows-tit"},le={class:"field"},ae={class:"condition"},ne={class:"content"},oe={class:"rows"},se={class:"field"},ie={class:"condition"},ce={class:"content"},re={key:0,class:"w-140px mr-8px"},ue={class:"flex-1 w-0"},de={class:"rows-btn"},pe=["onClick"],fe=t(_({__name:"index",props:B({isInit:{type:Boolean,default:!0}},{value:{default:()=>[]},valueModifiers:{}}),emits:["update:value"],setup(t,{expose:l}){const o=t,s=g(t,"value"),i=e(),c={type:"or",children:[]},r={input:"",select:null,show:!1,widget:{hint:"",placeholder:"",type:"text",value:[]}},p={type:"and",field:null,condition:null,conOptions:[],leftFactor:h(r),rightFactor:h(r)},f=["select","area_select"],v=["in","not_in"],m=j(()=>i.config.options.map(e=>({label:e.text,value:e.type,data:e}))),_=(e,t)=>(l,a)=>{const n=s.value[e].children[t],o=a.data;n.conOptions=o.operators.map(e=>({label:i.getOperatorName(e),value:e})),n.condition=o.operators[0]||null,n.leftFactor=h(r),n.rightFactor=h(r),o.left_factor_enabled&&(n.leftFactor.show=o.left_factor_enabled,n.leftFactor.widget=o.left_widget),o.right_factor_enabled&&(n.rightFactor.widget=o.right_widget,n.rightFactor.show=o.right_factor_enabled)},w=(e,t)=>l=>{const n=s.value[e].children[t],{rightFactor:o}=n,{widget:i}=o;if(f.includes(i.type)){if(null===o.select)return;v.includes(l||"")?o.select=a(o.select)?o.select:[o.select]:o.select=a(o.select)?o.select[0]:o.select}"text"===i.type&&(v.includes(l||"")&&""!==o.input&&(o.select=[o.input],o.input=""),null!==o.select&&(o.input=a(o.select)?o.select[0]:o.select))},$=j(()=>s.value.map(e=>e.children.length).reduce((e,t)=>e+t)>1),I=(e,t)=>t===s.value.length-1&&e===s.value[t].children.length-1,R=(e,t=0)=>{s.value[t].children.splice(e+1,0,h(p))},B=()=>{s.value.push(h(c)),R(0,s.value.length-1)},z=(e,t,l)=>"text"!==l.widget.type||v.includes(t)?"":e,N=(e,t,l)=>e&&e.includes(",")?e?e.split(","):[]:f.includes(l.widget.type)&&e||null;return o.isInit&&0===s.value.length&&B(),l({setRules:e=>{const t=[];e.children.forEach(e=>{const l=h(c);e.children.forEach(e=>{const{option:t}=e;if(!t)return;const a=h(p);a.field=t.type,a.condition=t.operator,((e,t)=>{const{options:l}=i.config;for(let a=0;a<l.length;a++)if(l[a].type===e){t(l[a]);break}})(t.type,e=>{if(e.left_factor_enabled){const l=(null==t?void 0:t.left_factor)||"";a.leftFactor.show=e.left_factor_enabled,a.leftFactor.widget=e.left_widget,a.leftFactor.input=z(l,t.operator,a.leftFactor),a.leftFactor.select=N(l,t.operator,a.leftFactor)}if(e.right_factor_enabled){const l=(null==t?void 0:t.right_factor)||"";a.rightFactor.show=e.right_factor_enabled,a.rightFactor.widget=e.right_widget,a.rightFactor.input=z(l,t.operator,a.rightFactor),a.rightFactor.select=N(l,t.operator,a.rightFactor)}a.conOptions=e.operators.map(e=>({label:i.getOperatorName(e),value:e}))}),l.children.push(a)}),t.push(l)}),t.length>0?s.value=t:B()}}),(e,t)=>{const l=d,a=u,o=n;return y(),E("div",null,[M("div",te,[M("div",le,k(e.$t("Waf.Custom.index_26")),1),M("div",ae,k(e.$t("Waf.Custom.index_27")),1),M("div",ne,k(e.$t("Waf.Custom.index_28")),1),t[0]||(t[0]=M("div",{class:"btn"},null,-1))]),(y(!0),E(O,null,A(s.value,(t,n)=>(y(),E("div",{key:"".concat(n+1)},[0!==n?(y(),x(K,{key:0})):P("",!0),(y(!0),E(O,null,A(t.children,(t,i)=>(y(),E("div",{key:"".concat(i+1)},[0!==i?(y(),x(T,{key:0})):P("",!0),M("div",oe,[M("div",se,[C(l,U({value:t.field,"onUpdate:value":e=>t.field=e,options:W(m),"consistent-menu-width":!1},L({"update:value":_(n,i)})),null,16,["value","onUpdate:value","options"])]),M("div",ie,[t.leftFactor.show?(y(),x(ee,{key:0,input:t.leftFactor.input,"onUpdate:input":e=>t.leftFactor.input=e,select:t.leftFactor.select,"onUpdate:select":e=>t.leftFactor.select=e,type:"left",condition:t.condition,factor:t.leftFactor},null,8,["input","onUpdate:input","select","onUpdate:select","condition","factor"])):(y(),x(l,U({key:1,value:t.condition,"onUpdate:value":e=>t.condition=e,disabled:null===t.field,options:t.conOptions,"consistent-menu-width":!1},L({"update:value":w(n,i)})),null,16,["value","onUpdate:value","disabled","options"]))]),M("div",ce,[t.leftFactor.show?(y(),E("div",re,[C(l,U({value:t.condition,"onUpdate:value":e=>t.condition=e,disabled:null===t.field,options:t.conOptions,"consistent-menu-width":!1},L({"update:value":w(n,i)})),null,16,["value","onUpdate:value","disabled","options"])])):P("",!0),M("div",ue,[C(ee,{input:t.rightFactor.input,"onUpdate:input":e=>t.rightFactor.input=e,select:t.rightFactor.select,"onUpdate:select":e=>t.rightFactor.select=e,type:"right",condition:t.condition,factor:t.rightFactor},null,8,["input","onUpdate:input","select","onUpdate:select","condition","factor"])])]),M("div",de,[C(a,{onClick:e=>R(i,n)},{default:b(()=>[F(k(e.$t("Waf.Custom.index_30")),1)]),_:2},1032,["onClick"]),I(i,n)?(y(),x(a,{key:0,class:"ml-8px",onClick:B},{default:b(()=>[F(k(e.$t("Waf.Custom.index_31")),1)]),_:1})):P("",!0),W($)?(y(),E("div",{key:1,class:"close",onClick:e=>((e,t)=>{const l=s.value[t];l.children.length>1?l.children.splice(e,1):s.value.splice(t,1)})(i,n)},[C(o,{name:"base-close",size:"16"})],8,pe)):P("",!0)])])]))),128))]))),128)),t[1]||(t[1]=M("div",null,null,-1))])}}}),[["__scopeId","data-v-31e9f077"]]),ve={class:"p-24px"},he={class:"form-title"},me={class:"w-320px"},_e={class:"w-320px"},ge={class:"form-title mt-8px"},we={class:"flex-1"},xe={class:"form-title mt-8px"},ye=t(_({__name:"index",props:{isEdit:{type:Boolean},row:{}},emits:["refresh"],setup(e,{expose:t,emit:l}){const r=e,d=l,f=N(r,"isEdit"),{t:h}=$(),_=S({name:"",server:[],action:"deny",response:null}),g={name:{trigger:["blur","input"],validator:()=>""!==_.name||new Error(h("Waf.Custom.index_18"))},rules:{validator:()=>{for(let e=0;e<x.value.length;e++){const t=x.value[e];for(let e=0;e<t.children.length;e++){const l=t.children[e];if(null===l.field||null===l.condition)return new Error(h("Waf.Custom.index_22"));const{leftFactor:a,rightFactor:n}=l;if(a.show&&""===a.input&&null===a.select)return new Error(h("Waf.Custom.index_22"));if(n.show&&""===n.input&&null===n.select)return new Error(h("Waf.Custom.index_22"))}}return!0}}},x=w([]),F=w(null),U=w(),j=()=>{_.server.length>0?c(_.server.join("\n")):o.error(h("Waf.Custom.index_24"))},O=()=>{const e=I();return x.value.forEach(t=>{const l=I("and");t.children.forEach(e=>{null===e.field&&null===e.condition||l.children.push(R(e))}),e.children.push(l)}),e},I=(e="or")=>({logic:e,type:"block",option:null,children:[]}),R=e=>({type:"option",logic:"",children:[],option:{type:e.field||"",operator:e.condition||"",left_factor:P(e.condition,e.leftFactor),right_factor:P(e.condition,e.rightFactor)}}),B=["in","not_in"],P=(e,t)=>{const{widget:l}=t;return"text"!==l.type||B.includes(e||"")?a(t.select)?t.select.join(","):t.select||"":t.input};return(()=>{if(!f.value)return;const{row:e}=r;e&&(_.name=e.name,_.server=e.servers||null,_.action=e.action.type,_.response=e.action.response.type,q(()=>{U.value.setRules(e.root)}))})(),t({onConfirm:async()=>{var e;await(null==(e=F.value)?void 0:e.validate());const t=(()=>{const{action:e,response:t}=_;return"allow"===e&&null===t&&(_.response="black_page"),{name:_.name,servers:_.server?_.server:[],status:1,is_global:0,priority:0,root:O(),action:{type:_.action,response:{type:_.response||"",response_id:0,status:0,headers:{},body:""}}}})(),{row:l}=r;f.value&&l?await s({infos:t,id:l.id}):await i(t),d("refresh")}}),(e,t)=>{const l=n,a=u,o=p,s=v,i=m;return y(),E("div",ve,[C(i,{ref_key:"formRef",ref:F,model:W(_),rules:g,"label-width":"140px","label-placement":"left","require-mark-placement":"left"},{default:b(()=>[M("div",he,k(e.$t("Waf.Custom.index_15")),1),C(o,{label:e.$t("Waf.Custom.index_16")},{default:b(()=>[M("div",me,[C(H,{value:W(_).server,"onUpdate:value":t[0]||(t[0]=e=>W(_).server=e)},null,8,["value"])]),C(a,{class:"ml-16px",onClick:j},{default:b(()=>[C(l,{name:"common-copy",class:"mr-6px",size:"14"}),M("span",null,k(e.$t("Waf.Custom.index_23")),1)]),_:1})]),_:1},8,["label"]),C(o,{label:e.$t("Waf.Custom.index_17"),path:"name"},{default:b(()=>[M("div",_e,[C(s,{value:W(_).name,"onUpdate:value":t[1]||(t[1]=e=>W(_).name=e),spellcheck:"false",placeholder:e.$t("Waf.Custom.index_18")},null,8,["value","placeholder"])])]),_:1},8,["label"]),M("div",ge,k(e.$t("Waf.Custom.index_19")),1),C(o,{label:"",class:"pl-36px",path:"rules"},{default:b(()=>[M("div",we,[C(fe,{ref_key:"ruleListRef",ref:U,value:W(x),"onUpdate:value":t[2]||(t[2]=e=>V(x)?x.value=e:null),"is-init":!W(f)},null,8,["value","is-init"])])]),_:1}),M("div",xe,k(e.$t("Waf.Custom.index_10")),1),C(G,{action:W(_).action,"onUpdate:action":t[3]||(t[3]=e=>W(_).action=e),response:W(_).response,"onUpdate:response":t[4]||(t[4]=e=>W(_).response=e)},null,8,["action","response"])]),_:1},8,["model"])])}}}),[["__scopeId","data-v-2a17c742"]]);export{ye as default};
