import{k as e,P as t,c as a,r as l,W as i,j as s,R as n,V as o,S as r,a3 as p,a4 as d,U as c,ak as u,a2 as f,au as m,an as _}from"./vue.js?v=1769066082311";import{ap as h,n as g,aG as x,fk as v,_ as w,m as y,p as b}from"./page_layout.js?v=1769066082311";import{f as C,u as z}from"./public.js?v=1769066082311";import{u as k,a as U}from"./index58.js?v=1769066082311";import{bJ as j,aC as F,dh as M,dd as S}from"./naive.js?v=1769066082311";import"./__commonjsHelpers__.js?v=1769066082311";import"./common.js?v=1769066082311";import"./index.vue_vue_type_script_setup_true_lang7.js?v=1769066082311";import"./index.vue_vue_type_script_setup_true_lang8.js?v=1769066082311";import"./CalcSize.vue_vue_type_script_setup_true_lang.js?v=1769066082311";import"./soft2.js?v=1769066082311";import"./soft.js?v=1769066082311";import"./site.js?v=1769066082311";import"./index.vue_vue_type_script_setup_true_lang.js?v=1769066082311";import"./file2.js?v=1769066082311";const P={class:"p-16px"},D={class:"flex items-center mb-12px"},B={key:1,class:"flex-center flex-col h-300px"},E={class:"drag-text"},A={key:0,class:"drag-suffix"},T=b(e({__name:"file-upload",props:{path:{default:""},node_id:{},size:{},uploadData:{default:()=>({multiple:!0})},uploadSuccess:{},showSuccessMsg:{type:Boolean,default:!0}},emits:["setConfirm"],setup(e,{expose:b,emit:T}){const $=e,L=T,{path:N,node_id:W}=$,{t:G}=t(),H=h(),I=a(()=>({multiple:!0,...$.uploadData})),J=l([]),O=l(new Map),R=a(()=>(I.value.accept||"").split(",").map(e=>"'".concat(e,"'")).join(", ")),V=e=>{var t,a,l;const{file:i}=e;return(null!=(a=null==(t=i.file)?void 0:t.size)?a:0)>1048576*(null!=(l=$.size)?l:1/0)?(y.error(G("Component.UploadFile.index_7",[i.name,$.size])),!1):(I.value.multiple||(J.value=[]),!0)},q=l([{key:"name",title:G("Component.UploadFile.index_3"),ellipsis:!0},{key:"size",title:G("Component.UploadFile.index_4"),width:100,render:e=>{var t;return g(null==(t=e.file)?void 0:t.size)}},{key:"status",title:G("Component.UploadFile.index_5"),width:140,render:e=>{if("pending"===e.status)return G("Component.UploadFile.index_8");if("finished"===e.status)return i("span",{class:"text-primary"},[G("Component.UploadFile.index_9")]);if("error"===e.status)return i("span",{class:"text-error"},[s("Upload Failed")]);const t=e.percentage?e.percentage.toFixed(1):0;return i(j,{type:"line",color:H.value.primaryColor,"indicator-placement":"outside",processing:!0,percentage:Number(t)},null)}},C({width:70,options:(e,t)=>[{label:G("Public.Btn.Del"),type:"error",show:"uploading"!==e.status,onClick:()=>J.value.splice(t,1)},{label:G("Public.Btn.Cancel"),type:"warning",show:"uploading"===e.status,onClick:()=>(e=>{const t=e.id||e.name,a=O.value.get(t);a&&(a.abort(),O.value.delete(t),e.status="error",e.percentage=0,y.info("Upload Canceled: ".concat(e.name)))})(e)}]})]),K=async(e,t,a,l)=>{const i=10485760,s=Math.ceil(e.size/i);let n=0;for(let p=0;p<s;p++){if(l.signal.aborted)throw new Error("Upload Canceled");const s=n,d=Math.min(e.size,s+i),c=e.slice(s,d),u=d-s,f=new FormData;f.append("f_path",N),f.append("f_name",t),f.append("f_size",e.size.toString()),f.append("f_start",s.toString()),f.append("blob",c),f.append("node_id",W);try{const t=await U(f,t=>{if(l.signal.aborted)return;const i=(n+(t.progress||0)*u)/e.size*100;a(Math.min(i,99))});let s=d;if(t&&"number"==typeof t.message&&(s=t.message),n=Math.max(n,s),a(Math.min(n/e.size*100,99)),n>=e.size)break;p=Math.floor(n/i)-1}catch(o){let e=!1;for(let t=0;t<3;t++){if(l.signal.aborted)throw new Error("Upload Canceled");try{await new Promise(e=>setTimeout(e,1e3));const t=await U(f);if(t&&"number"==typeof t.message){n=t.message,e=!0;break}}catch(r){e=!1}}if(!e)throw new Error("Chunk ".concat(p+1," upload failed"))}}return a(100),!0};return b({onConfirm:async()=>{var e;const t=J.value.filter(e=>"pending"===e.status);if(!t.length)return y.error(G("Component.UploadFile.index_10")),!1;const a=e=>{const t=e.fullPath||e.name;return($.path.endsWith("/")?$.path:$.path+"/")+t},l=t.map(e=>a(e)).join("\n"),{message:s}=await k({files:l,node_id:W});let n=t;if(Array.isArray(s)){const e=s.filter(e=>e.exists);if(e.length>0){const l=await new Promise(l=>{z({title:G("file.uploadModal.conflictTitle"),width:600,footer:!0,confirmText:G("file.uploadModal.conflictOverwrite"),cancelText:G("file.uploadModal.conflictSkip"),onConfirm:()=>l("overwrite"),onPublicClose:()=>l("skip"),onClose:()=>l("cancel"),content:()=>{const l=e.map(e=>{var l;const i=t.find(t=>a(t)===e.filename);return{...e,localSize:(null==(l=null==i?void 0:i.file)?void 0:l.size)||0}});return i("div",{class:"p-20px"},[i("div",{class:"flex items-center gap-10px mb-16px"},[i(w,{name:"base-warning",size:"30",class:"text-warning"},null),i("div",{class:"flex-1 w-0 text-14px"},[G("file.uploadModal.conflictMessage")])]),i(M,{"max-height":300,data:l,columns:[{title:G("file.uploadModal.conflictFileName"),key:"filename",render:e=>i(S,null,{default:()=>[i("span",null,[e.filename.split("/").pop()])]})},{title:G("file.uploadModal.conflictFileDifference"),key:"difference",width:220,render:e=>i("div",{class:"flex items-center"},[i("span",{class:"color-primary"},[g(e.localSize)]),i("i",{class:"i-material-symbols:arrow-right-alt-rounded mx-5px text-18px"},null),i("span",{class:"color-gray"},[g(e.size)])])}]},null)])}})});if("cancel"===l)return!1;if("skip"===l){const l=new Set(e.map(e=>e.filename));n=t.filter(e=>!l.has(a(e))),t.forEach(e=>{l.has(a(e))&&(e.status="finished",e.percentage=100)})}}}if(!n.length)return y.info(G("All files are skipped")),!0;L("setConfirm",{disabled:!0}),n.forEach(e=>e.status="uploading");let o=!0,r=!1;for(const i of n){const e=i.file;if(!e)continue;const t=new AbortController,a=i.id||i.name;O.value.set(a,t);try{if(e.size>52428800){if(!(await K(e,i.name,e=>i.percentage=e,t))||t.signal.aborted){i.status="error",r=!0;continue}}else{const a=new FormData;a.append("f_path",N),a.append("f_name",i.name),a.append("f_start","0"),a.append("f_size",e.size.toString()),a.append("blob",e),a.append("node_id",W),await U(a,e=>{t.signal.aborted||(i.percentage=100*(e.progress||0))})}if(t.signal.aborted){i.status="error",r=!0;continue}i.status="finished"}catch(d){i.status="error",y.error("".concat(i.name," upload failed}")),o=!1}finally{O.value.delete(a)}}if(o&&!r&&$.showSuccessMsg){t.filter(e=>"finished"===e.status).length&&y.success(G("Component.UploadFile.index_9"))}L("setConfirm",{disabled:!1});const p=t.filter(e=>"finished"===e.status);return p.length&&await(null==(e=$.uploadSuccess)?void 0:e.call($,p)),o&&!r}}),(e,t)=>{const a=F,l=x,h=v;return o(),n("div",P,[r("div",D,[i(l,{ref:"upload",class:"w-auto","file-list":c(J),"onUpdate:fileList":t[0]||(t[0]=e=>u(J)?J.value=e:null),accept:c(I).accept,multiple:c(I).multiple,"default-upload":!1,"show-file-list":!1,onBeforeUpload:V},{default:p(()=>[i(a,{type:"primary"},{default:p(()=>[s(d(e.$t("Component.UploadFile.index_6")),1)]),_:1})]),_:1},8,["file-list","accept","multiple"])]),i(l,{ref:"upload",class:"w-auto","file-list":c(J),"onUpdate:fileList":t[2]||(t[2]=e=>u(J)?J.value=e:null),accept:c(I).accept,multiple:c(I).multiple,"default-upload":!1,"show-file-list":!1,onBeforeUpload:V},{default:p(()=>[i(h,null,{default:p(()=>[c(J).length>0?(o(),f(c(M),{key:0,"max-height":300,bordered:!1,data:c(J),columns:c(q),onClick:t[1]||(t[1]=m(()=>{},["stop"]))},null,8,["data","columns"])):(o(),n("div",B,[i(w,{name:"base-upload",size:"48",class:"text-#999"}),r("div",E,d(e.$t("Component.UploadFile.index_1")),1),c(I).accept?(o(),n("div",A,d(e.$t("Component.UploadFile.index_2",[c(R)])),1)):_("",!0)]))]),_:1})]),_:1},8,["file-list","accept","multiple"])])}}}),[["__scopeId","data-v-1b421c9e"]]);export{T as default};
