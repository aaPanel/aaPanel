import{ap as e,n as a,aG as t,fk as s,_ as l,m as n,p as o}from"./page_layout.js?v=1769066082311";import{k as i,P as r,r as p,c as d,W as c,j as u,R as f,V as m,S as g,a3 as h,a4 as _,U as b,ak as w,a2 as x,au as C,an as v}from"./vue.js?v=1769066082311";import{f as y}from"./public.js?v=1769066082311";import{b as U}from"./file.js?v=1769066082311";import{bJ as z,aC as k,dh as F}from"./naive.js?v=1769066082311";import"./common.js?v=1769066082311";import"./__commonjsHelpers__.js?v=1769066082311";const j={class:"p-16px"},M={class:"flex items-center mb-12px"},S={key:1,class:"flex-center flex-col h-300px"},B={class:"drag-text"},D={key:0,class:"drag-suffix"},E=o(i({__name:"index",props:{path:{default:""},size:{},uploadData:{default:()=>({multiple:!1})},uploadSuccess:{},showSuccessMsg:{type:Boolean,default:!0}},emits:["setConfirm"],setup(o,{expose:i,emit:E}){const P=o,$=E,{path:L,uploadData:A}=P,{t:G}=r(),H=e(),I=p([]),J=p(new Map),N=d(()=>(A.accept||"").split(",").map(e=>"'".concat(e,"'")).join(", ")),R=e=>{var a,t,s;const{file:l}=e;return(null!=(t=null==(a=l.file)?void 0:a.size)?t:0)>1048576*(null!=(s=P.size)?s:1/0)?(n.error(G("Component.UploadFile.index_7",[l.name,P.size])),!1):(A.multiple||(I.value=[]),!0)},T=p([{key:"name",title:G("Component.UploadFile.index_3"),ellipsis:!0},{key:"size",title:G("Component.UploadFile.index_4"),width:100,render:e=>{var t;return a(null==(t=e.file)?void 0:t.size)}},{key:"status",title:G("Component.UploadFile.index_5"),width:140,render:e=>{if("pending"===e.status)return G("Component.UploadFile.index_8");if("finished"===e.status)return c("span",{class:"text-primary"},[G("Component.UploadFile.index_9")]);if("error"===e.status)return c("span",{class:"text-error"},[u("Upload Failed")]);const a=e.percentage?e.percentage.toFixed(1):0;return c(z,{type:"line",color:H.value.primaryColor,"indicator-placement":"outside",processing:!0,percentage:Number(a)},null)}},y({width:70,options:(e,a)=>[{label:G("Public.Btn.Del"),type:"error",show:"uploading"!==e.status,onClick:()=>I.value.splice(a,1)},{label:G("Public.Btn.Cancel"),type:"warning",show:"uploading"===e.status,onClick:()=>(e=>{const a=e.id||e.name,t=J.value.get(a);t&&(t.abort(),J.value.delete(a),e.status="error",e.percentage=0,n.info("Upload Canceled: ".concat(e.name)))})(e)}]})]),V=async(e,a,t,s)=>{const l=10485760,n=Math.ceil(e.size/l);let o=0;for(let p=0;p<n;p++){if(s.signal.aborted)throw new Error("Upload Canceled");const n=o,d=Math.min(e.size,n+l),c=e.slice(n,d),u=d-n,f=new FormData;f.append("f_path",L),f.append("f_name",a),f.append("f_size",e.size.toString()),f.append("f_start",n.toString()),f.append("blob",c);try{const a=await U(f,a=>{if(s.signal.aborted)return;const l=(o+(a.progress||0)*u)/e.size*100;t(Math.min(l,99))});let n=d;if(a&&"number"==typeof a.message&&(n=a.message),o=Math.max(o,n),t(Math.min(o/e.size*100,99)),o>=e.size)break;p=Math.floor(o/l)-1}catch(i){let e=!1;for(let a=0;a<3;a++){if(s.signal.aborted)throw new Error("Upload Canceled");try{await new Promise(e=>setTimeout(e,1e3));const a=await U(f);if(a&&"number"==typeof a.message){o=a.message,e=!0;break}}catch(r){e=!1}}if(!e)throw new Error("Chunk ".concat(p+1," upload failed"))}}return t(100),!0};return i({onConfirm:async()=>{var e;const a=I.value.filter(e=>"pending"===e.status);if(!a.length)return n.error(G("Component.UploadFile.index_10")),!1;$("setConfirm",{disabled:!0}),a.forEach(e=>e.status="uploading");let t=!0,s=!1;for(const i of a){const e=i.file;if(!e)continue;const a=new AbortController,l=i.id||i.name;J.value.set(l,a);try{if(e.size>52428800){if(!(await V(e,i.name,e=>i.percentage=e,a))||a.signal.aborted){i.status="error",s=!0;continue}}else{const t=new FormData;t.append("f_path",L),t.append("f_name",i.name),t.append("f_start","0"),t.append("f_size",e.size.toString()),t.append("blob",e),await U(t,e=>{a.signal.aborted||(i.percentage=100*(e.progress||0))})}if(a.signal.aborted){i.status="error",s=!0;continue}i.status="finished"}catch(o){i.status="error",n.error("".concat(i.name," upload failed}")),t=!1}finally{J.value.delete(l)}}if(t&&!s&&P.showSuccessMsg){a.filter(e=>"finished"===e.status).length&&n.success(G("Component.UploadFile.index_9"))}$("setConfirm",{disabled:!1});const l=a.filter(e=>"finished"===e.status);return l.length&&await(null==(e=P.uploadSuccess)?void 0:e.call(P,l)),t&&!s}}),(e,a)=>{const n=k,o=t,i=F,r=l,p=s;return m(),f("div",j,[g("div",M,[c(o,{ref:"upload",class:"w-auto","file-list":b(I),"onUpdate:fileList":a[0]||(a[0]=e=>w(I)?I.value=e:null),accept:b(A).accept,multiple:b(A).multiple,"default-upload":!1,"show-file-list":!1,onBeforeUpload:R},{default:h(()=>[c(n,{type:"primary"},{default:h(()=>[u(_(e.$t("Component.UploadFile.index_6")),1)]),_:1})]),_:1},8,["file-list","accept","multiple"])]),c(o,{ref:"upload",class:"w-auto","file-list":b(I),"onUpdate:fileList":a[2]||(a[2]=e=>w(I)?I.value=e:null),accept:b(A).accept,multiple:b(A).multiple,"default-upload":!1,"show-file-list":!1,onBeforeUpload:R},{default:h(()=>[c(p,null,{default:h(()=>[b(I).length>0?(m(),x(i,{key:0,"max-height":300,bordered:!1,data:b(I),columns:b(T),onClick:a[1]||(a[1]=C(()=>{},["stop"]))},null,8,["data","columns"])):(m(),f("div",S,[c(r,{name:"base-upload",size:"48",class:"text-#999"}),g("div",B,_(e.$t("Component.UploadFile.index_1")),1),b(A).accept?(m(),f("div",D,_(e.$t("Component.UploadFile.index_2",[b(N)])),1)):v("",!0)]))]),_:1})]),_:1},8,["file-list","accept","multiple"])])}}}),[["__scopeId","data-v-fd46742b"]]);export{E as default};
